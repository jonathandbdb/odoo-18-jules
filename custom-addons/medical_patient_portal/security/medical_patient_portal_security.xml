<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="0"> <!-- noupdate="0" for groups and rules that might be modified manually later -->

        <!-- Portal User Access Group (Implicitly used by Odoo Portal) -->
        <!-- We typically rely on base.group_portal -->

        <!-- Record Rule: Patient can only see their own medical appointments -->
        <record id="medical_appointment_portal_patient_rule" model="ir.rule">
            <field name="name">Patient Portal: Own Medical Appointments</field>
            <field name="model_id" ref="medical_appointment.model_medical_appointment"/>
            <field name="domain_force">[('patient_id','=',user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/> <!-- Portal users typically don't write directly -->
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Record Rule: Patient can only see their own EHR records (e.g., Prescriptions) -->
        <!-- This is a generic example; more specific rules might be needed per EHR model -->
        <record id="medical_prescription_portal_patient_rule" model="ir.rule">
            <field name="name">Patient Portal: Own Prescriptions</field>
            <field name="model_id" ref="medical_ehr.model_medical_prescription"/>
            <field name="domain_force">[('patient_id','=',user.partner_id.id), ('state', 'in', ['active', 'dispensed', 'expired'])]</field>
            <!-- Only show active, dispensed or expired prescriptions -->
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Record Rule: Patient can only see their own Medical Studies (results) -->
        <record id="medical_patient_study_portal_patient_rule" model="ir.rule">
            <field name="name">Patient Portal: Own Medical Studies</field>
            <field name="model_id" ref="medical_ehr.model_medical_patient_study"/>
            <field name="domain_force">[('patient_id','=',user.partner_id.id), ('status', 'in', ['completed', 'reviewed'])]</field>
            <!-- Only show completed/reviewed studies to patient -->
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Record Rule: Patient can see their own res.partner record (for personal details) -->
        <record id="res_partner_portal_patient_rule" model="ir.rule">
            <field name="name">Patient Portal: Own Partner Record</field>
            <field name="model_id" ref="base.model_res_partner"/>
            <field name="domain_force">[('id','=',user.partner_id.id)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="True"/> <!-- Allow editing own details if portal form supports it -->
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Optional: If there are specific EHR sub-records a patient should see, add rules for them -->
        <!-- e.g., Medical History items like allergies, if they are to be displayed.
        <record id="medical_patient_allergy_portal_patient_rule" model="ir.rule">
            <field name="name">Patient Portal: Own Allergies</field>
            <field name="model_id" ref="medical_ehr.model_medical_patient_allergy"/>
            <field name="domain_force">[('patient_id','=',user.partner_id.id), ('active','=',True)]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>
        -->

        <!-- Ensure Portal users can access related configuration data if needed for display names, etc. -->
        <!-- Example: Medical Specialty (if displayed on appointment list) -->
        <record id="medical_specialty_portal_public_rule" model="ir.rule">
            <field name="name">Patient Portal: Public Medical Specialties</field>
            <field name="model_id" ref="medical_appointment.model_medical_specialty"/>
            <field name="domain_force">[]</field> <!-- Allow access to all, or filter by some criteria -->
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Example: Medical Study Type (if displayed on study list) -->
        <record id="medical_study_type_portal_public_rule" model="ir.rule">
            <field name="name">Patient Portal: Public Medical Study Types</field>
            <field name="model_id" ref="medical_ehr.model_medical_study_type"/>
            <field name="domain_force">[]</field>
            <field name="groups" eval="[(4, ref('base.group_portal'))]"/>
            <field name="perm_read" eval="True"/>
            <field name="perm_write" eval="False"/>
            <field name="perm_create" eval="False"/>
            <field name="perm_unlink" eval="False"/>
        </record>

        <!-- Note: Access to res.partner for doctors (for display names) is typically handled by base rules
             or specific rules in other medical modules. Portal users should generally not be able to browse
             all doctors, only see names related to their records. -->

    </data>
</odoo>
