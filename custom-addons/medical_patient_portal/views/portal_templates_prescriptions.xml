<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template for listing medical prescriptions in the portal -->
    <template id="portal_my_prescriptions_list" name="My Medical Prescriptions">
        <t t-call="portal.portal_layout">
            <t t-set="medical_area" t-value="True"/>
            <t t-set="page_name" t-value="'prescriptions'"/>

            <!-- Breadcrumb -->
            <ol class="breadcrumb">
                <t t-call="medical_patient_portal.portal_breadcrumb_medical_base"/>
                <li class="breadcrumb-item active">
                    Prescriptions
                </li>
            </ol>

            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">My Prescriptions</t>
            </t>

            <t t-if="not prescriptions">
                <div class="alert alert-info mt-3" role="alert">
                    You have no prescriptions on record matching the current filter.
                </div>
            </t>

            <t t-if="prescriptions">
                <div class="table-responsive mt-3">
                    <table class="table table-hover o_portal_my_doc_table">
                        <thead class="bg-light">
                            <tr>
                                <th class="text-center">Prescription ID</th>
                                <th class="text-center">Date</th>
                                <th>Doctor</th>
                                <th>Status</th>
                                <th/> <!-- For detail/download buttons -->
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="prescriptions" t-as="prescription">
                                <tr>
                                    <td class="text-center"><a t-attf-href="/my/medical/prescription/#{prescription.id}?{{ keep_query() }}"><span t-field="prescription.name"/></a></td>
                                    <td class="text-center">
                                        <span t-field="prescription.prescription_date" t-options='{"widget": "date"}'/>
                                    </td>
                                    <td>
                                        <span t-if="prescription.doctor_id" t-field="prescription.doctor_id.name"/>
                                        <span t-else="">N/A</span>
                                    </td>
                                    <td>
                                        <span t-if="prescription.state == 'active'" class="badge bg-success">Active</span>
                                        <span t-if="prescription.state == 'expired'" class="badge bg-warning">Expired</span>
                                        <span t-if="prescription.state == 'cancelled'" class="badge bg-danger">Cancelled</span>
                                        <span t-if="prescription.state == 'dispensed'" class="badge bg-info">Dispensed</span>
                                        <span t-if="prescription.state == 'draft'" class="badge bg-secondary">Draft</span>
                                    </td>
                                    <td class="text-end">
                                        <a t-attf-href="/my/medical/prescription/#{prescription.id}?{{ keep_query() }}" class="btn btn-sm btn-outline-primary me-1" title="View Details">
                                            <i class="fa fa-eye"/> <span class="d-none d-md-inline">Details</span>
                                        </a>
                                        <a t-if="prescription.state in ['active', 'dispensed']"
                                           t-attf-href="/my/medical/prescription/pdf/#{prescription.id}?{{ keep_query() }}"
                                           class="btn btn-sm btn-outline-secondary" title="Download PDF">
                                           <i class="fa fa-download"/> <span class="d-none d-md-inline">Download</span>
                                        </a>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
            </t>
            <div t-if="pager" class="o_portal_pager text-center">
                <t t-call="portal.pager"/>
            </div>
        </t>
    </template>

    <!-- Template for individual prescription detail (placeholder for now) -->
    <template id="portal_prescription_detail_page" name="Prescription Detail">
        <t t-call="portal.portal_layout">
            <t t-set="medical_area" t-value="True"/>
            <t t-set="page_name" t-value="'prescription_detail'"/>

            <!-- Breadcrumb specific to this page -->
             <ol class="breadcrumb">
                <t t-call="medical_patient_portal.portal_breadcrumb_medical_base"/>
                <li class="breadcrumb-item">
                    <a href="/my/medical/prescriptions">My Prescriptions</a>
                </li>
                <li class="breadcrumb-item active">
                    <t t-esc="prescription.name or 'Prescription Details'"/>
                </li>
            </ol>

            <div class="container mt-4" t-if="prescription">
                <h3>Prescription: <span t-field="prescription.name"/></h3>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Details</h5>
                            </div>
                            <div class="card-body">
                                <p><strong>Date:</strong> <span t-field="prescription.prescription_date" t-options='{"widget": "date"}'/></p>
                                <p><strong>Doctor:</strong> <span t-field="prescription.doctor_id.name"/></p>
                                <p><strong>Status:</strong>
                                    <span t-if="prescription.state == 'active'" class="badge bg-success">Active</span>
                                    <span t-if="prescription.state == 'expired'" class="badge bg-warning">Expired</span>
                                    <span t-if="prescription.state == 'cancelled'" class="badge bg-danger">Cancelled</span>
                                    <span t-if="prescription.state == 'dispensed'" class="badge bg-info">Dispensed</span>
                                    <span t-if="prescription.state == 'draft'" class="badge bg-secondary">Draft</span>
                                </p>
                                <t t-if="prescription.consultation_id">
                                    <p><strong>Linked Consultation:</strong> <a t-attf-href="/my/medical/consultation/#{prescription.consultation_id.id}"><span t-field="prescription.consultation_id.name"/></a></p>
                                </t>
                                <t t-if="prescription.notes">
                                    <p><strong>General Notes:</strong><br/><span t-field="prescription.notes" widget="text"/></p>
                                </t>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h5 class="mb-0">Medications</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Medication</th>
                                                <th>Dosage</th>
                                                <th>Form</th>
                                                <th>Route</th>
                                                <th>Frequency</th>
                                                <th>Duration</th>
                                                <th>Qty</th>
                                                <th>Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="prescription.prescription_line_ids" t-as="line">
                                                <tr>
                                                    <td><span t-field="line.medication_id.name"/></td>
                                                    <td><span t-field="line.dosage"/></td>
                                                    <td><span t-field="line.form_id.name"/></td>
                                                    <td><span t-field="line.route_id.name"/></td>
                                                    <td><span t-field="line.frequency"/></td>
                                                    <td><span t-field="line.duration"/></td>
                                                    <td><span t-field="line.quantity"/></td>
                                                    <td><span t-field="line.notes"/></td>
                                                </tr>
                                            </t>
                                            <tr t-if="not prescription.prescription_line_ids">
                                                <td colspan="8" class="text-center">No medications listed for this prescription.</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 mt-3 mt-lg-0">
                        <div class="d-grid gap-2">
                             <a t-if="prescription.state in ['active', 'dispensed']"
                                t-attf-href="/my/medical/prescription/pdf/#{prescription.id}"
                                class="btn btn-primary">
                                <i class="fa fa-download"/> Download PDF
                             </a>
                             <!-- Other actions could be added here -->
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="/my/medical/prescriptions" class="btn btn-secondary">
                        <i class="fa fa-chevron-left"/> Back to Prescriptions
                    </a>
                </div>
            </div>
            <div class="container mt-4" t-else="">
                <div class="alert alert-warning" role="alert">
                    The requested prescription could not be found or you do not have access to it.
                </div>
            </div>
        </t>
    </template>
</odoo>
